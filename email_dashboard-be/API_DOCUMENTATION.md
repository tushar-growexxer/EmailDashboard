# Email Dashboard API Documentation

## Overview

This is a secure REST API for user management built with Node.js, Express, TypeScript, and SAP HANA database. The API provides authentication, authorization, and CRUD operations for user management with role-based access control.

## Features

- **JWT Authentication**: Secure token-based authentication
- **Role-Based Access Control (RBAC)**: Admin and user roles with different permissions
- **Password Security**: Bcrypt hashing for secure password storage
- **SAP HANA Integration**: Native SAP HANA database connectivity
- **Input Validation**: Comprehensive request validation
- **Error Handling**: Global error handling with meaningful error messages
- **Security**: Helmet, CORS, rate limiting, and request logging
- **TypeScript**: Full type safety and IntelliSense support

## Prerequisites

- Node.js (v18 or higher)
- pnpm package manager
- SAP HANA database access
- TypeScript

## Installation

1. Clone the repository and navigate to the backend directory:
```bash
cd email_dashboard-be
```

2. Install dependencies:
```bash
pnpm install
```

3. Create a `.env` file in the root directory with the following variables:
```env
# Server Configuration
NODE_ENV=development
PORT=3000
API_VERSION=v1

# CORS Configuration
CORS_ORIGIN=http://localhost:5173

# Rate Limiting
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100

# JWT Configuration
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production
JWT_EXPIRES_IN=8h

# SAP HANA Database Configuration
DB_HOST=your-hana-host
DB_PORT=30015
DB_USER=your-db-username
DB_PASSWORD=your-db-password
DB_SCHEMA=YOUR_SCHEMA
DB_USERS_TABLE=YOUR_USERS_TABLE
```

4. Set up your SAP HANA database table:
```sql
CREATE TABLE "YOUR_SCHEMA"."YOUR_USERS_TABLE" (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    fullName NVARCHAR(255) NOT NULL,
    email NVARCHAR(255) NOT NULL UNIQUE,
    password NVARCHAR(255) NOT NULL,
    role NVARCHAR(20) NOT NULL CHECK (role IN ('admin', 'user')),
    createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updatedAt TIMESTAMP
);
```

## Running the Application

### Development Mode
```bash
pnpm dev
```

### Production Build
```bash
pnpm build
pnpm start
```

### Other Commands
```bash
pnpm lint          # Run ESLint
pnpm lint:fix      # Fix ESLint issues
pnpm format        # Format code with Prettier
pnpm type-check    # Run TypeScript type checking
```

## API Endpoints

### Base URL
```
http://localhost:3000/api/v1
```

### Authentication Endpoints

#### POST /auth/login
Authenticate a user and receive a JWT token.

**Request Body:**
```json
{
  "email": "user@example.com",
  "password": "password123"
}
```

**Response (200):**
```json
{
  "success": true,
  "message": "Login successful",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": 1,
    "fullName": "John Doe",
    "email": "user@example.com",
    "role": "admin"
  }
}
```

#### POST /auth/logout
Logout endpoint (client-side token removal).

**Response (200):**
```json
{
  "success": true,
  "message": "Logout successful"
}
```

#### GET /auth/profile
Get current user profile (requires authentication).

**Headers:**
```
Authorization: Bearer <token>
```

**Response (200):**
```json
{
  "success": true,
  "user": {
    "id": 1,
    "fullName": "John Doe",
    "email": "user@example.com",
    "role": "admin",
    "createdAt": "2024-01-01T00:00:00.000Z"
  }
}
```

#### GET /auth/validate
Validate JWT token (requires authentication).

**Headers:**
```
Authorization: Bearer <token>
```

**Response (200):**
```json
{
  "success": true,
  "message": "Token is valid",
  "user": {
    "userId": 1,
    "email": "user@example.com",
    "role": "admin"
  }
}
```

### User Management Endpoints (Admin Only)

All user management endpoints require:
- JWT authentication
- Admin role authorization

#### POST /users
Create a new user.

**Headers:**
```
Authorization: Bearer <admin-token>
```

**Request Body:**
```json
{
  "fullName": "Jane Doe",
  "email": "jane@example.com",
  "password": "password123",
  "role": "user"
}
```

**Response (201):**
```json
{
  "success": true,
  "message": "User created successfully",
  "user": {
    "id": 2,
    "fullName": "Jane Doe",
    "email": "jane@example.com",
    "role": "user",
    "createdAt": "2024-01-01T00:00:00.000Z"
  }
}
```

#### GET /users
Get all users.

**Headers:**
```
Authorization: Bearer <admin-token>
```

**Response (200):**
```json
{
  "success": true,
  "users": [
    {
      "id": 1,
      "fullName": "John Doe",
      "email": "john@example.com",
      "role": "admin",
      "createdAt": "2024-01-01T00:00:00.000Z"
    },
    {
      "id": 2,
      "fullName": "Jane Doe",
      "email": "jane@example.com",
      "role": "user",
      "createdAt": "2024-01-01T00:00:00.000Z"
    }
  ]
}
```

#### GET /users/:id
Get a single user by ID.

**Headers:**
```
Authorization: Bearer <admin-token>
```

**Response (200):**
```json
{
  "success": true,
  "user": {
    "id": 2,
    "fullName": "Jane Doe",
    "email": "jane@example.com",
    "role": "user",
    "createdAt": "2024-01-01T00:00:00.000Z",
    "updatedAt": null
  }
}
```

#### PUT /users/:id
Update a user by ID.

**Headers:**
```
Authorization: Bearer <admin-token>
```

**Request Body:**
```json
{
  "fullName": "Jane Smith",
  "role": "admin"
}
```

**Response (200):**
```json
{
  "success": true,
  "message": "User updated successfully",
  "user": {
    "id": 2,
    "fullName": "Jane Smith",
    "email": "jane@example.com",
    "role": "admin",
    "createdAt": "2024-01-01T00:00:00.000Z",
    "updatedAt": "2024-01-01T12:00:00.000Z"
  }
}
```

#### DELETE /users/:id
Delete a user by ID.

**Headers:**
```
Authorization: Bearer <admin-token>
```

**Response (200):**
```json
{
  "success": true,
  "message": "User deleted successfully"
}
```

## Error Responses

### 400 Bad Request
```json
{
  "success": false,
  "message": "Invalid request body or validation error"
}
```

### 401 Unauthorized
```json
{
  "success": false,
  "message": "Authentication required or invalid credentials"
}
```

### 403 Forbidden
```json
{
  "success": false,
  "message": "Insufficient permissions"
}
```

### 404 Not Found
```json
{
  "success": false,
  "message": "Resource not found"
}
```

### 500 Internal Server Error
```json
{
  "success": false,
  "message": "Internal server error"
}
```

## Security Features

1. **Password Hashing**: All passwords are hashed using bcrypt with 12 salt rounds
2. **JWT Tokens**: Secure token-based authentication with configurable expiration
3. **Role-Based Access**: Admin-only endpoints for user management
4. **Input Validation**: Comprehensive validation for all inputs
5. **Rate Limiting**: Protection against brute force attacks
6. **CORS**: Configurable cross-origin resource sharing
7. **Helmet**: Security headers for protection against common vulnerabilities
8. **Request Logging**: Comprehensive logging for monitoring and debugging

## Database Schema

The API expects a SAP HANA table with the following structure:

```sql
CREATE TABLE "YOUR_SCHEMA"."YOUR_USERS_TABLE" (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    fullName NVARCHAR(255) NOT NULL,
    email NVARCHAR(255) NOT NULL UNIQUE,
    password NVARCHAR(255) NOT NULL,
    role NVARCHAR(20) NOT NULL CHECK (role IN ('admin', 'user')),
    createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updatedAt TIMESTAMP
);
```

## Testing the API

You can test the API using tools like Postman, curl, or any HTTP client. Here's an example workflow:

1. **Create an admin user** (you'll need to do this directly in the database first):
```sql
INSERT INTO "YOUR_SCHEMA"."YOUR_USERS_TABLE" (fullName, email, password, role)
VALUES ('Admin User', 'admin@example.com', '$2a$12$hashedpassword', 'admin');
```

2. **Login to get a token**:
```bash
curl -X POST http://localhost:3000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email": "admin@example.com", "password": "yourpassword"}'
```

3. **Use the token for authenticated requests**:
```bash
curl -X GET http://localhost:3000/api/v1/users \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

## Project Structure

```
src/
├── config/
│   ├── database.ts      # Database connection configuration
│   └── logger.ts        # Winston logger configuration
├── controllers/
│   ├── auth.controller.ts   # Authentication controller
│   └── user.controller.ts   # User management controller
├── middlewares/
│   ├── auth.middleware.ts       # JWT authentication & RBAC
│   ├── error.middleware.ts      # Global error handling
│   ├── requestLogger.middleware.ts  # Request logging
│   └── validation.middleware.ts     # Input validation
├── models/
│   └── User.ts           # User model and database operations
├── routes/
│   ├── auth.routes.ts    # Authentication routes
│   ├── user.routes.ts    # User management routes
│   └── index.ts          # Main router
├── services/
│   └── user.service.ts   # User business logic
├── app.ts               # Express app configuration
└── server.ts            # Server startup and database connection
```

## Contributing

1. Follow TypeScript best practices
2. Use JSDoc comments for all functions
3. Ensure all endpoints have proper error handling
4. Write comprehensive tests
5. Follow the existing code structure and patterns

## License

This project is licensed under the ISC License.
